# Outstanding Payments Feature - Visual Architecture

## Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Admin Payments Page                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   OutstandingPayments Component     â”‚
        â”‚   (outstanding-payments.tsx)        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚              â”‚
                     â†“              â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   useEffect  â”‚  â”‚   useState   â”‚
            â”‚   (Fetch)    â”‚  â”‚   (States)   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   API Call                          â”‚
        â”‚   GET /payments/outstanding         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Backend - Express Route           â”‚
        â”‚   router.get('/outstanding')        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Controller Function               â”‚
        â”‚   getOutstandingPayments()          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Database Queries                  â”‚
        â”‚   PostgreSQL                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Architecture

```
OutstandingPayments
â”‚
â”œâ”€â”€ useEffect (fetch data)
â”‚
â”œâ”€â”€ useCallback (fetch function)
â”‚
â”œâ”€â”€ State Management
â”‚   â”œâ”€â”€ data: OutstandingPayments | null
â”‚   â”œâ”€â”€ loading: boolean
â”‚   â”œâ”€â”€ error: string
â”‚   â””â”€â”€ expandedDetails: boolean
â”‚
â””â”€â”€ Render Structure
    â”‚
    â”œâ”€â”€ Header Section
    â”‚   â””â”€â”€ Title + Description
    â”‚
    â”œâ”€â”€ Summary Cards Row (Grid 1x3)
    â”‚   â”œâ”€â”€ Total Outstanding Card
    â”‚   â”œâ”€â”€ Outstanding Jobs Card
    â”‚   â””â”€â”€ Customers Owed Card
    â”‚
    â”œâ”€â”€ Payment Aging Card
    â”‚   â””â”€â”€ Aging breakdown items
    â”‚       â””â”€â”€ Current | Overdue | Very Overdue | Critical
    â”‚
    â””â”€â”€ Top Outstanding Jobs Card
        â”œâ”€â”€ Header (Expandable)
        â””â”€â”€ Expanded Content
            â””â”€â”€ Job items list (top 10)
                â”œâ”€â”€ Job info
                â”œâ”€â”€ Cost breakdown
                â”œâ”€â”€ Customer contact
                â””â”€â”€ View Job button
```

## Database Schema Relationship

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      JOBS        â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)          â”‚
â”‚ ticket_id        â”‚
â”‚ customer_id (FK) â”‚
â”‚ worker_id (FK)   â”‚
â”‚ total_cost       â”‚
â”‚ amount_paid      â”‚ â† Used for balance calc
â”‚ balance          â”‚ â† [Outstanding]
â”‚ updated_at       â”‚ â† Used for aging
â”‚ status           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€ LEFT JOIN â†’ CUSTOMERS (id)
        â”‚   â””â”€ name, phone, email
        â”‚
        â””â”€ LEFT JOIN â†’ USERS (id)
            â””â”€ name (worker)


Outstanding Payments Filter:
WHERE balance > 0
```

## API Response Structure

```
GET /api/payments/outstanding
â†“
{
  "summary": {                          â† Dashboard cards
    "outstanding_jobs_count": 15,
    "total_outstanding_amount": 2500000,
    "customers_with_outstanding": 8,
    "last_updated": "2025-12-19T..."
  },
  
  "aging": [                            â† Aging breakdown
    {
      "category": "Current (0-30 days)",
      "count": 5,
      "amount": 250000
    },
    {
      "category": "Overdue (31-60 days)",
      "count": 8,
      "amount": 1200000
    },
    // ... more categories
  ],
  
  "detailed": [                         â† Top 10 jobs
    {
      "id": "uuid",
      "ticket_id": "PRESS-001",
      "outstanding_amount": 500000,
      "total_cost": 800000,
      "amount_paid": 300000,
      "customer_name": "John Smith",
      "customer_phone": "08012345678",
      "worker_name": "Ahmed",
      "updated_at": "2025-12-10T..."
    },
    // ... 9 more jobs
  ]
}
```

## Page Layout (Mobile & Desktop)

### Desktop View (1920px+)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Outstanding Payments - Manage and track pending payments  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Total      â”‚  Outstanding â”‚  Customers   â”‚
â”‚Outstanding  â”‚     Jobs     â”‚    Owed      â”‚
â”‚  â‚¦2.5m      â”‚      15      â”‚       8      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Payment Aging Analysis                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Current (0-30d)  â”‚ 5 jobs   â”‚ â‚¦250k                  â”‚
â”‚ â€¢ Overdue (31-60d) â”‚ 8 jobs   â”‚ â‚¦1.2m                  â”‚
â”‚ â€¢ Very Overdue     â”‚ 2 jobs   â”‚ â‚¦800k                  â”‚
â”‚ â€¢ Critical (90+)   â”‚ 0 jobs   â”‚ â‚¦0                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Top Outstanding Jobs â–¼                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PRESS-001 | Smith | â‚¦500k Outstanding          [View Job]â”‚
â”‚ â€¢ Total: â‚¦800k | Paid: â‚¦300k | Worker: Ahmed            â”‚
â”‚ â€¢ ðŸ“ž 08012345678 | Updated: 2025-12-10                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PRESS-002 | Johnson | â‚¦400k Outstanding       [View Job] â”‚
â”‚ â€¢ Total: â‚¦700k | Paid: â‚¦300k | Worker: Fatima           â”‚
â”‚ â€¢ ðŸ“ž 08087654321 | Updated: 2025-12-09                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Mobile View (375px)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Outstanding Payments        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Total Outstanding           â”‚
â”‚ â‚¦2.5m                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Outstanding Jobs            â”‚
â”‚ 15                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Customers Owed              â”‚
â”‚ 8                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Payment Aging               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Current (0-30d)             â”‚
â”‚ 5 jobs | â‚¦250k              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Overdue (31-60d)            â”‚
â”‚ 8 jobs | â‚¦1.2m              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Top Outstanding â–¼           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PRESS-001                   â”‚
â”‚ Smith | â‚¦500k               â”‚
â”‚ â‚¦800k total | â‚¦300k paid    â”‚
â”‚ [View Job]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Color & Styling System

### Summary Cards
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Icon]  Amount     â”‚
â”‚          â‚¦2.5m      â”‚ â† Total Outstanding (Red ðŸ”´)
â”‚          Title      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Icon]  Count      â”‚
â”‚          15         â”‚ â† Outstanding Jobs (Orange ðŸŸ )
â”‚          Title      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Icon]  Count      â”‚
â”‚          8          â”‚ â† Customers Owed (Purple ðŸŸ£)
â”‚          Title      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Aging Badges
```
[âœ“ Blue]     Current (0-30 days)
[âš  Yellow]   Overdue (31-60 days)
[! Orange]   Very Overdue (61-90 days)
[âœ• Red]      Critical (90+ days)
```

## State Management Flow

```
Initial State
â”œâ”€ data: null
â”œâ”€ loading: true
â”œâ”€ error: ''
â””â”€ expandedDetails: false

        â†“

Component Mounted
useEffect triggers
        â†“

Fetch Data
â”œâ”€ setLoading(true)
â”œâ”€ API call
        â†“

Response Received
â”œâ”€ setData(response.data)
â”œâ”€ setLoading(false)
â””â”€ setError('')

        â†“

Render with Data
â”œâ”€ Summary cards show totals
â”œâ”€ Aging chart shows breakdown
â”œâ”€ Expandable details ready
â””â”€ Click to expand jobs list

        â†“

User Interaction
â”œâ”€ Click arrow
â”œâ”€ setExpandedDetails(!expandedDetails)
â”œâ”€ Show/hide job details
â””â”€ Click "View Job"
    â””â”€ Navigate to /admin/jobs/[id]
```

## Error Handling Flow

```
API Call
    â†“
â”œâ”€ Success (200)
â”‚  â””â”€ setData, setLoading(false)
â”‚
â”œâ”€ Error (50x)
â”‚  â””â”€ catch block
â”‚     â”œâ”€ setError(message)
â”‚     â””â”€ setLoading(false)
â”‚
â””â”€ Network Error
   â””â”€ catch block
      â”œâ”€ setError('Failed to load')
      â””â”€ setLoading(false)

        â†“

Render
â”œâ”€ Loading: Show spinner
â”œâ”€ Error: Show error message
â”œâ”€ Success: Show data
â””â”€ Empty: Show "No outstanding" message
```

---

## Performance Optimization

```
Query Optimization:
â”œâ”€ WHERE j.balance > 0        (indexes on balance)
â”œâ”€ LIMIT 10                   (limited result set)
â”œâ”€ LEFT JOIN (indexed FK)     (fast lookups)
â””â”€ COUNT(DISTINCT)            (efficient counting)

Result: ~100ms query time

Frontend Optimization:
â”œâ”€ useCallback                (stable fetch function)
â”œâ”€ Limited result set         (only top 10)
â”œâ”€ Lazy expand               (only load when needed)
â””â”€ Simple calculations        (no heavy processing)

Result: Instant render after data loaded
```
